name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate-manifest:
    name: Validate manifest and JSON
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate integration manifest.json
        run: |
          python - <<'PY'
          import json,sys
          path = 'custom_components/climate_react/manifest.json'
          try:
              with open(path,'r',encoding='utf-8') as f:
                  json.load(f)
          except Exception as e:
              print('manifest.json validation failed:', e)
              sys.exit(1)
          print('manifest.json OK')
          PY
      - name: Validate strings.json
        run: |
          python - <<'PY'
          import json,sys
          path = 'custom_components/climate_react/strings.json'
          try:
              with open(path,'r',encoding='utf-8') as f:
                  json.load(f)
          except Exception as e:
              print('strings.json validation failed:', e)
              sys.exit(1)
          print('strings.json OK')
          PY
      - name: Validate translations/en.json
        run: |
          python - <<'PY'
          import json,sys
          path = 'custom_components/climate_react/translations/en.json'
          try:
              with open(path,'r',encoding='utf-8') as f:
                  json.load(f)
          except Exception as e:
              print('en.json validation failed:', e)
              sys.exit(1)
          print('en.json OK')
          PY
      - name: Check import
        run: |
          python - <<'PY'
          import sys
          sys.path.insert(0, '.')
          try:
              import custom_components.climate_react
          except Exception as e:
              print('Import failed:', e)
              sys.exit(1)
          print('Import OK')
          PY

  lint:
    name: Lint (ruff + black)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dev dependencies
        run: python -m pip install --upgrade pip && pip install ruff black
      - name: Run ruff
        run: ruff check .
      - name: Check formatting with black
        run: black --check .

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install mypy
        run: python -m pip install --upgrade pip && pip install mypy
      - name: Run mypy (ignore missing imports for HA runtime libs)
        run: mypy custom_components || true

  tests:
    name: Run tests (pytest)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install test deps
        run: python -m pip install --upgrade pip && pip install pytest
      - name: Run pytest (if tests present)
        run: |
          if [ -d tests ]; then
            pytest -q
          else
            echo "No tests directory; skipping pytest"
          fi
